<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>自由的灵魂 - 自动匹配</title>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
    <style>
        body { background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); color: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden; position: relative; }
        .night { position: absolute; width: 100%; height: 100%; transform: rotateZ(45deg); pointer-events: none; }
        .shooting_star { position: absolute; left: 50%; top: 50%; height: 2px; background: linear-gradient(-45deg, #5f91ff, rgba(0,0,255,0)); border-radius: 999px; animation: tail 3s ease-in-out infinite, shooting 3s ease-in-out infinite; }
        @keyframes tail { 0% { width: 0; } 30% { width: 100px; } 100% { width: 0; } }
        @keyframes shooting { 0% { transform: translateX(0); } 100% { transform: translateX(300px); } }
        
        #main-ui { text-align: center; z-index: 10; }
        h1 { font-weight: 200; letter-spacing: 4px; font-size: 1.5rem; }
        .enter-btn { padding: 15px 40px; background: white; color: black; border: none; cursor: pointer; border-radius: 30px; font-weight: bold; font-size: 1rem; }

        #chat-container { display: none; flex-direction: column; width: 92%; max-width: 500px; z-index: 20; height: 80vh; }
        #chat-box { width: 100%; flex: 1; background: rgba(255,255,255,0.08); overflow-y: auto; padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; backdrop-filter: blur(15px); box-sizing: border-box; }
        #input-area { width: 100%; display: flex; gap: 8px; opacity: 0.3; pointer-events: none; transition: 0.5s; }
        #msg-input { flex: 1; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid #444; color: white; border-radius: 10px; font-size: 16px; outline: none; }
        .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        #send-btn { background: #5f91ff; color: white; }
    </style>
</head>
<body>
    <div class="night"><div class="shooting_star"></div><div class="shooting_star"></div></div>

    <div id="main-ui">
        <h1>这里欢迎每一个渴望自由的灵魂</h1>
        <button class="enter-btn" onclick="startMatching()">寻找缘分</button>
    </div>

    <div id="chat-container">
        <div id="chat-box">
            <div id="status" style="color: #aaa; text-align: center; font-size: 0.9rem; margin-top: 50%;">正在星空中寻找另一半灵魂...</div>
        </div>
        <div id="input-area" id="input-group">
            <input type="text" id="msg-input" placeholder="输入你想说的..." onkeydown="if(event.keyCode==13) sendMsg()">
            <button id="send-btn" class="btn" onclick="sendMsg()">发送</button>
            <button style="background:rgba(255,255,255,0.1); color:#ccc" class="btn" onclick="location.reload()">离开</button>
        </div>
    </div>

    <script>
        const lobbyChannel = "soul_lobby_v1"; // 匹配大厅
        let privateChannel = null;
        const myID = "Soul_" + Math.random().toString(36).substring(7);

        const pubnub = new PubNub({
            publishKey: 'pub-c-48098c76-50d4-469b-8212-076f8e75294e',
            subscribeKey: 'sub-c-134e626e-4421-11eb-a5a4-325b0351f2f8',
            uuid: myID
        });

        function startMatching() {
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            
            // 订阅大厅并开启在线状态监听
            pubnub.subscribe({ 
                channels: [lobbyChannel],
                withPresence: true 
            });
        }

        pubnub.addListener({
            presence: function(p) {
                // 如果大厅里有两个或更多人，自动根据时间顺序配对
                if (p.channel === lobbyChannel && p.occupancy >= 2) {
                    // 简单的配对算法：前两个进入的人自动进入专属房间
                    // 实际应用中会更复杂，这里我们让大家进入一个基于当前分钟的半私密房
                    const pairId = Math.floor(Date.now() / 600000); // 每10分钟变换一次的基础ID
                    privateChannel = "room_" + pairId;
                    
                    pubnub.subscribe({ channels: [privateChannel] });
                    document.getElementById('status').innerHTML = "--- 缘分已连接 ---<br><small>此刻，星空下只有你们两人</small>";
                    document.getElementById('input-area').style.opacity = "1";
                    document.getElementById('input-area').style.pointerEvents = "auto";
                }
            },
            message: function(event) {
                if (event.channel === privateChannel) {
                    const box = document.getElementById('chat-box');
                    const isMe = event.publisher === myID;
                    const div = document.createElement('div');
                    div.style.margin = "12px 0";
                    div.innerHTML = `<span style="color:${isMe?'#5f91ff':'#ff9f43'}; font-weight:bold;">${isMe?'我':'缘分'}:</span> <span>${event.message.text}</span>`;
                    box.appendChild(div);
                    box.scrollTop = box.scrollHeight;
                }
            }
        });

        function sendMsg() {
            const input = document.getElementById('msg-input');
            if (input.value.trim() !== "" && privateChannel) {
                pubnub.publish({ channel: privateChannel, message: { text: input.value } });
                input.value = "";
            }
        }
    </script>
</body>
</html>
