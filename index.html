<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ¿åæ˜Ÿç©º - è‡ªç”±çš„çµé­‚</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #5f91ff; }
        body { background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); color: #fff; margin: 0; font-family: -apple-system, sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* é¦–é¡µç‰¹æ•ˆï¼šæ–‡å­—æµå…‰ */
        #home-ui { text-align: center; z-index: 100; transition: 0.8s; }
        .welcome-title { 
            font-size: 1.6rem; font-weight: 200; letter-spacing: 5px; margin-bottom: 50px; line-height: 1.6;
            background: linear-gradient(120deg, #fff 10%, var(--accent) 50%, #fff 90%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: flow 5s linear infinite;
        }
        @keyframes flow { to { background-position: 200% center; } }
        .enter-btn { padding: 18px 50px; background: transparent; border: 1px solid rgba(255,255,255,0.4); color: #fff; border-radius: 40px; cursor: pointer; font-size: 1rem; backdrop-filter: blur(10px); }

        /* èŠå¤©ç•Œé¢ */
        #chat-ui { display: none; flex-direction: column; width: 92vw; max-width: 500px; height: 92vh; z-index: 100; }
        #status { text-align: center; font-size: 11px; color: var(--accent); margin-bottom: 8px; opacity: 0.7; }
        #msg-box { flex: 1; background: rgba(255,255,255,0.05); border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); overflow-y: auto; padding: 18px; display: flex; flex-direction: column; gap: 12px; backdrop-filter: blur(15px); }
        
        .msg { padding: 12px 18px; border-radius: 20px; max-width: 80%; font-size: 15px; word-break: break-all; }
        .me { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 4px; }
        .other { background: rgba(255,255,255,0.15); align-self: flex-start; border-bottom-left-radius: 4px; }

        .input-bar { display: flex; align-items: center; gap: 10px; padding: 15px 0; }
        #v-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: #fff; font-size: 20px; cursor: pointer; }
        #v-btn.rec { background: #ff4d4d; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,77,77,0.4); } 70% { box-shadow: 0 0 0 10px rgba(255,77,77,0); } }
        input { flex: 1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); padding: 12px 18px; border-radius: 25px; color: #fff; outline: none; }
    </style>
</head>
<body>
    <div id="home-ui">
        <h1 class="welcome-title">è¿™é‡Œæ¬¢è¿æ¯ä¸€ä¸ªæ¸´æœ›è‡ªç”±çš„çµé­‚</h1>
        <button class="enter-btn" onclick="startEngine()">å¼€å¯çµé­‚å…±é¸£</button>
    </div>

    <div id="chat-ui">
        <div id="status">æ­£åœ¨åŒæ­¥æ˜Ÿè½¨...</div>
        <div id="msg-box"></div>
        <div class="input-area">
            <div class="input-bar">
                <button id="v-btn" ontouchstart="rOn(event)" ontouchend="rOff(event)" onmousedown="rOn(event)" onmouseup="rOff(event)">ğŸ¤</button>
                <input type="text" id="ipt" placeholder="è¾“å…¥..." autocomplete="off">
                <button onclick="doSend()" style="background:transparent; border:none; color:var(--accent); font-weight:bold; font-size:16px;">å‘é€</button>
            </div>
            <div style="text-align:center;"><button onclick="location.reload()" style="background:none; border:none; color:rgba(255,255,255,0.2); font-size:10px;">åˆ‡æ–­å¹¶é‡è¿</button></div>
        </div>
    </div>

    <script>
        let peer, conn, recorder, chunks = [], heartTimer;
        // ä¿æŒå”¯ä¸€é…å¯¹ ID
        const IDA = "SOUL_X_2026_A"; const IDB = "SOUL_X_2026_B";

        function startEngine() {
            document.getElementById('home-ui').style.display = 'none';
            document.getElementById('chat-ui').style.display = 'flex';
            
            // æ¯æ¬¡å¼ºåˆ¶æ–°å»º Peer
            peer = new Peer(IDA, { debug: 1 });
            peer.on('open', () => { updateStatus("æœå¯»ä¸­..."); link(IDB); });
            peer.on('connection', c => bind(c));
            peer.on('error', e => {
                if(e.type === 'unavailable-id') {
                    peer = new Peer(IDB, { debug: 1 });
                    peer.on('open', () => { updateStatus("å‘ç°ä¿¡å·..."); link(IDA); });
                }
            });
        }

        function link(target) {
            const t = setInterval(() => {
                if (conn && conn.open) return clearInterval(t);
                let c = peer.connect(target, { reliable: true });
                c.on('open', () => { bind(c); clearInterval(t); });
            }, 1000);
        }

        function bind(c) {
            if(conn) return; 
            conn = c;
            updateStatus("âœ¨ çµé­‚å¥‘åˆæˆåŠŸ");
            
            // å¯åŠ¨å¿ƒè·³æ£€æµ‹ï¼Œé˜²æ­¢è™šè¿
            if(heartTimer) clearInterval(heartTimer);
            heartTimer = setInterval(() => {
                if(conn && conn.open) conn.send({ type: 'hb' });
                else updateStatus("ğŸ”´ ä¿¡å·ä¸¢å¤±ï¼Œæ­£åœ¨è‡ªåŠ¨å¯¹é½...");
            }, 3000);

            conn.on('data', data => {
                if(data.type === 'hb') return; // è¿‡æ»¤å¿ƒè·³åŒ…
                if(data.type === 'voice') {
                    const blob = new Blob([data.data], { type: 'audio/webm' });
                    render(blob, false, true);
                } else {
                    render(data, false, false);
                }
            });
            conn.on('close', () => location.reload());
        }

        function doSend() {
            const el = document.getElementById('ipt');
            const val = el.value.trim();
            if(!val || !conn || !conn.open) return;
            conn.send(val);
            render(val, true, false);
            el.value = '';
        }

        async function rOn(e) {
            e.preventDefault();
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(s); chunks = [];
                recorder.ondataavailable = ev => chunks.push(ev.data);
                recorder.onstop = async () => {
                    const b = new Blob(chunks, { type: 'audio/webm' });
                    const buffer = await b.arrayBuffer();
                    if(conn && conn.open) {
                        conn.send({ type: 'voice', data: buffer });
                        render(b, true, true);
                    }
                    s.getTracks().forEach(t => t.stop());
                };
                recorder.start();
                document.getElementById('v-btn').classList.add('rec');
            } catch(err) { alert("éº¦å…‹é£æˆæƒå¤±è´¥"); }
        }

        function rOff(e) {
            e.preventDefault();
            if(recorder && recorder.state === 'recording') {
                recorder.stop();
                document.getElementById('v-btn').classList.remove('rec');
            }
        }

        function render(content, isMe, isVoice) {
            const box = document.getElementById('msg-box');
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'other'}`;
            if(isVoice) {
                const url = URL.createObjectURL(content instanceof Blob ? content : new Blob([content]));
                div.innerHTML = `ğŸ”Š è¯­éŸ³æ¶ˆæ¯ (ç‚¹å‡»æ’­æ”¾)`;
                div.onclick = () => { new Audio(url).play().catch(() => alert("è¯·å…³é—­é™éŸ³å¼€å…³")); };
            } else { div.innerText = content; }
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function updateStatus(s) { document.getElementById('status').innerText = s; }
        document.getElementById('ipt').onkeydown = e => { if(e.key === 'Enter') doSend(); };
    </script>
</body>
</html>
