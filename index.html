<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡ªç”±çš„çµé­‚ - è¯­éŸ³ä¿®å¤ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0a0a1a; color: #fff; font-family: sans-serif; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        #chat-container { display: none; flex-direction: column; width: 100%; max-width: 500px; height: 100%; position: relative; z-index: 10; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,0.02); }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; font-size: 15px; line-height: 1.4; position: relative; }
        .me { background: #3b82f6; align-self: flex-end; border-bottom-right-radius: 4px; }
        .other { background: #2d2d3f; align-self: flex-start; border-bottom-left-radius: 4px; }
        .voice-btn-inner { cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .voice-btn-inner::before { content: 'â–¶ï¸'; font-size: 12px; }
        .input-area { padding: 15px; background: #161625; display: flex; gap: 10px; align-items: center; }
        #voice-rec { width: 50px; height: 50px; border-radius: 25px; border: none; background: #2d2d3f; color: white; font-size: 20px; flex-shrink: 0; }
        #voice-rec.active { background: #ef4444; animation: blink 1s infinite; }
        input { flex: 1; background: #2d2d3f; border: none; padding: 12px; border-radius: 20px; color: white; outline: none; }
        #status { position: absolute; top: 10px; width: 100%; text-align: center; font-size: 12px; color: #60a5fa; pointer-events: none; }
        @keyframes blink { 50% { opacity: 0.6; } }
        #init-ui { position: absolute; top: 50%; transform: translateY(-50%); text-align: center; }
        .start-btn { padding: 15px 40px; border: 1px solid #fff; background: none; color: #fff; border-radius: 30px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="init-ui"><button class="start-btn" onclick="start()">å¼€å¯æ˜Ÿç©ºè¿æ¥</button></div>
    
    <div id="chat-container">
        <div id="status">è¿æ¥ä¸­...</div>
        <div id="chat-box"></div>
        <div class="input-area">
            <button id="voice-rec" onmousedown="startRec()" onmouseup="stopRec()" ontouchstart="startRec()" ontouchend="stopRec()">ğŸ¤</button>
            <input type="text" id="msg-input" placeholder="è¾“å…¥æ˜Ÿè¯­..." autocomplete="off">
            <button onclick="sendText()" style="background:none; border:none; color:#3b82f6; font-weight:bold;">å‘é€</button>
        </div>
    </div>

    <script>
        let peer, conn, recorder, chunks = [];
        const ID_A = "room_final_A", ID_B = "room_final_B";

        function start() {
            document.getElementById('init-ui').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            peer = new Peer(ID_A);
            peer.on('open', () => tryConnect(ID_B));
            peer.on('connection', c => { conn = c; initConn(); });
            peer.on('error', (e) => { if(e.type === 'unavailable-id') { peer = new Peer(ID_B); peer.on('open', () => tryConnect(ID_A)); } });
        }

        function tryConnect(target) {
            const t = setInterval(() => {
                if(conn) return clearInterval(t);
                let c = peer.connect(target);
                c.on('open', () => { conn = c; initConn(); clearInterval(t); });
            }, 1000);
        }

        function initConn() {
            document.getElementById('status').innerText = "âœ¨ å·²è¿›å…¥åŒé¢‘ç‡æ˜Ÿç©º";
            conn.on('data', data => {
                if(data.type === 'audio') {
                    // ä¿®å¤ç‚¹ï¼šå°†æ¥æ”¶åˆ°çš„ ArrayBuffer è½¬å›ä¸ºå¯æ’­æ”¾çš„ Blob
                    const blob = new Blob([data.data], { type: 'audio/webm' });
                    renderVoice(blob, false);
                } else {
                    renderText(data, false);
                }
            });
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šè¯­éŸ³å½•åˆ¶ä¸ä¼ è¾“ ---
        async function startRec() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    renderVoice(blob, true);
                    // ä¿®å¤ç‚¹ï¼šå°† Blob è½¬æ¢ä¸º ArrayBuffer è¿›è¡Œæå…¶ç¨³å®šçš„äºŒè¿›åˆ¶ä¼ è¾“
                    const buffer = await blob.arrayBuffer();
                    if(conn) conn.send({ type: 'audio', data: buffer });
                    stream.getTracks().forEach(t => t.stop());
                };
                recorder.start();
                document.getElementById('voice-rec').classList.add('active');
            } catch(e) { alert("è¯·å…è®¸å¼€å¯éº¦å…‹é£"); }
        }

        function stopRec() {
            if(recorder && recorder.state === 'recording') {
                recorder.stop();
                document.getElementById('voice-rec').classList.remove('active');
            }
        }

        function renderVoice(blob, isMe) {
            const url = URL.createObjectURL(blob);
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'other'}`;
            // ä¿®å¤ç‚¹ï¼šå¢åŠ ä¸€ä¸ªæ˜¾çœ¼çš„æ’­æ”¾å›¾æ ‡ï¼Œå¹¶ç¡®ä¿æ¯æ¬¡ç‚¹å‡»éƒ½èƒ½é‡æ–°åŠ è½½éŸ³é¢‘å¯¹è±¡
            div.innerHTML = `<div class="voice-btn-inner" onclick="playAudio('${url}')">è¯­éŸ³æ¶ˆæ¯ (ç‚¹å‡»æ’­æ”¾)</div>`;
            const box = document.getElementById('chat-box');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function playAudio(url) {
            const audio = new Audio(url);
            audio.play().catch(e => alert("æ‰‹æœºç«¯è¯·åœ¨é™éŸ³æ¨¡å¼å¤–ç‚¹å‡»æ’­æ”¾"));
        }

        function renderText(t, isMe) {
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'other'}`;
            div.innerText = t;
            document.getElementById('chat-box').appendChild(div);
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
        }

        function sendText() {
            const ipt = document.getElementById('msg-input');
            if(ipt.value && conn) {
                renderText(ipt.value, true);
                conn.send(ipt.value);
                ipt.value = '';
            }
        }
    </script>
</body>
</html>
