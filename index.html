<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ¿åæ˜Ÿç©º - è‡ªç”±çš„çµé­‚</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --main-blue: #5f91ff; }
        body { background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); color: #fff; margin: 0; font-family: -apple-system, sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* é¦–é¡µ UI ç‰¹æ•ˆ */
        #home-ui { text-align: center; z-index: 100; animation: fadeIn 1.5s ease; }
        .welcome-text { 
            font-size: 1.6rem; font-weight: 200; letter-spacing: 5px; margin-bottom: 50px;
            background: linear-gradient(120deg, #fff 20%, var(--main-blue) 50%, #fff 80%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 5s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .start-btn { 
            padding: 16px 45px; background: transparent; border: 1px solid rgba(255,255,255,0.4);
            color: #fff; border-radius: 40px; cursor: pointer; font-size: 1rem;
            box-shadow: 0 0 20px rgba(95,145,255,0.2); transition: 0.3s;
        }
        .start-btn:hover { border-color: #fff; background: rgba(255,255,255,0.05); }

        /* èŠå¤©ç•Œé¢ */
        #chat-ui { display: none; flex-direction: column; width: 92vw; max-width: 500px; height: 88vh; z-index: 100; }
        #status-info { text-align: center; font-size: 12px; color: var(--main-blue); margin-bottom: 10px; height: 18px; }
        #msg-box { flex: 1; background: rgba(255,255,255,0.05); border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; backdrop-filter: blur(10px); }
        
        /* æ°”æ³¡ */
        .msg { padding: 12px 18px; border-radius: 20px; max-width: 80%; font-size: 15px; line-height: 1.4; word-break: break-all; }
        .me { background: var(--main-blue); align-self: flex-end; border-bottom-right-radius: 4px; }
        .other { background: rgba(255,255,255,0.15); align-self: flex-start; border-bottom-left-radius: 4px; }

        /* è¾“å…¥åŒº */
        .input-bar { display: flex; align-items: center; gap: 10px; padding: 15px 0; }
        #v-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: #fff; font-size: 20px; cursor: pointer; }
        #v-btn.active { background: #ff4d4d; box-shadow: 0 0 15px rgba(255,77,77,0.5); }
        input { flex: 1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); padding: 12px 18px; border-radius: 25px; color: #fff; outline: none; }
    </style>
</head>
<body>
    <div id="home-ui">
        <h1 class="welcome-text">è¿™é‡Œæ¬¢è¿æ¯ä¸€ä¸ªæ¸´æœ›è‡ªç”±çš„çµé­‚</h1>
        <button class="start-btn" onclick="openGate()">å¼€å¯çµé­‚åŒ¹é…</button>
    </div>

    <div id="chat-ui">
        <div id="status-info">æ˜Ÿè½¨åŒæ­¥ä¸­...</div>
        <div id="msg-box"></div>
        <div class="input-bar">
            <button id="v-btn" onmousedown="recStart(event)" onmouseup="recEnd(event)" ontouchstart="recStart(event)" ontouchend="recEnd(event)">ğŸ¤</button>
            <input type="text" id="ipt" placeholder="è¾“å…¥çµæ„Ÿ..." autocomplete="off">
            <button onclick="handleSend()" style="background:transparent; border:none; color:var(--main-blue); font-weight:bold; font-size:16px; padding:0 10px;">å‘é€</button>
        </div>
        <button onclick="location.reload()" style="background:none; border:none; color:rgba(255,255,255,0.2); font-size:11px; margin-top:5px;">åˆ‡æ–­å½“å‰æ„Ÿåº”</button>
    </div>

    <script>
        let peer, conn, recorder, chunks = [];
        const ID_A = "SOUL_A_2026"; 
        const ID_B = "SOUL_B_2026";

        function openGate() {
            document.getElementById('home-ui').style.display = 'none';
            document.getElementById('chat-ui').style.display = 'flex';
            
            peer = new Peer(ID_A);
            peer.on('open', () => {
                setStatus("å¯»æ‰¾çµé­‚é¢‘ç‡...");
                link(ID_B);
            });
            peer.on('connection', c => { if(!conn) initConn(c); });
            peer.on('error', e => {
                if(e.type === 'unavailable-id') {
                    peer = new Peer(ID_B);
                    peer.on('open', () => { setStatus("é¢‘ç‡å·²å‘ç°ï¼Œæ­£åœ¨å¯¹å‡†..."); link(ID_A); });
                }
            });
        }

        function link(target) {
            const t = setInterval(() => {
                if (conn && conn.open) return clearInterval(t);
                let c = peer.connect(target, { reliable: true });
                c.on('open', () => { initConn(c); clearInterval(t); });
            }, 1200);
        }

        function initConn(c) {
            conn = c;
            setStatus("âœ¨ å¥‘åˆæˆåŠŸ");
            conn.on('data', data => {
                if(data.type === 'voice') renderMsg(data.blob, false, true);
                else renderMsg(data, false, false);
            });
            conn.on('close', () => location.reload());
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿æ¶ˆæ¯ 100% é€å‡º ---
        function handleSend() {
            const ipt = document.getElementById('ipt');
            const val = ipt.value.trim();
            if(!val) return;
            
            if(conn && conn.open) {
                conn.send(val);
                renderMsg(val, true, false);
                ipt.value = '';
            } else {
                setStatus("ğŸ”´ ä¿¡å·æ³¢åŠ¨ï¼Œå°è¯•é‡è¿...");
            }
        }

        async function recStart(e) {
            e.preventDefault();
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(s);
                chunks = [];
                recorder.ondataavailable = ev => chunks.push(ev.data);
                recorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    if(conn && conn.open) {
                        const buffer = await blob.arrayBuffer(); // è½¬Bufferå‘é€
                        conn.send({ type: 'voice', blob: buffer });
                        renderMsg(blob, true, true);
                    }
                    s.getTracks().forEach(t => t.stop());
                };
                recorder.start();
                document.getElementById('v-btn').classList.add('active');
            } catch(err) { alert("éº¦å…‹é£æœªæˆæƒ"); }
        }

        function recEnd(e) {
            e.preventDefault();
            if(recorder && recorder.state === 'recording') {
                recorder.stop();
                document.getElementById('v-btn').classList.remove('active');
            }
        }

        function renderMsg(content, isMe, isVoice) {
            const box = document.getElementById('msg-box');
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'other'}`;
            
            if(isVoice) {
                const url = URL.createObjectURL(content instanceof Blob ? content : new Blob([content]));
                div.innerHTML = `ğŸµ è¯­éŸ³æ¶ˆæ¯ (ç‚¹å‡»æ’­æ”¾)`;
                div.style.cursor = "pointer";
                div.onclick = () => { new Audio(url).play().catch(() => alert("è¯·å…³é—­é™éŸ³æ¨¡å¼")); };
            } else {
                div.innerText = content;
            }
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function setStatus(s) { document.getElementById('status-info').innerText = s; }
        document.getElementById('ipt').onkeydown = e => { if(e.key === 'Enter') handleSend(); };
    </script>
</body>
</html>
