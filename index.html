<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ¿åæ˜Ÿç©º - è‡ªç”±çš„çµé­‚</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #5f91ff; --bg: #000; }
        body { background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); color: #fff; margin: 0; font-family: -apple-system, sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* é¦–é¡µç‰¹æ•ˆï¼šæ˜Ÿç©ºæ„Ÿ UI */
        #home-ui { text-align: center; z-index: 100; padding: 20px; transition: 0.8s; }
        .welcome-title { 
            font-size: 1.6rem; font-weight: 200; letter-spacing: 5px; margin-bottom: 50px; line-height: 1.6;
            background: linear-gradient(120deg, #fff 10%, var(--accent) 50%, #fff 90%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: flow 5s linear infinite;
        }
        @keyframes flow { to { background-position: 200% center; } }
        .enter-btn { padding: 18px 50px; background: transparent; border: 1px solid rgba(255,255,255,0.4); color: #fff; border-radius: 40px; cursor: pointer; font-size: 1rem; backdrop-filter: blur(10px); transition: 0.3s; box-shadow: 0 0 20px rgba(95,145,255,0.1); }
        .enter-btn:hover { border-color: #fff; background: rgba(255,255,255,0.05); }

        /* èŠå¤©ç•Œé¢ */
        #chat-ui { display: none; flex-direction: column; width: 92vw; max-width: 500px; height: 90vh; z-index: 100; }
        #status { text-align: center; font-size: 12px; color: var(--accent); margin-bottom: 10px; height: 20px; letter-spacing: 1px; }
        #msg-box { flex: 1; background: rgba(255,255,255,0.04); border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); overflow-y: auto; padding: 18px; display: flex; flex-direction: column; gap: 12px; backdrop-filter: blur(15px); }
        
        /* æ°”æ³¡æ ·å¼ */
        .msg { padding: 12px 18px; border-radius: 20px; max-width: 80%; font-size: 15px; line-height: 1.4; word-break: break-all; position: relative; }
        .me { background: var(--accent); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
        .other { background: rgba(255,255,255,0.15); align-self: flex-start; border-bottom-left-radius: 4px; }

        /* è¾“å…¥äº¤äº’åŒº */
        .input-bar { display: flex; align-items: center; gap: 10px; padding: 15px 0; }
        #v-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: #fff; font-size: 20px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        #v-btn.rec { background: #ff4d4d; box-shadow: 0 0 15px rgba(255,77,77,0.5); transform: scale(1.1); }
        input { flex: 1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); padding: 12px 18px; border-radius: 25px; color: #fff; outline: none; font-size: 16px; }
    </style>
</head>
<body>
    <div id="home-ui">
        <h1 class="welcome-title">è¿™é‡Œæ¬¢è¿æ¯ä¸€ä¸ªæ¸´æœ›è‡ªç”±çš„çµé­‚</h1>
        <button class="enter-btn" onclick="start()">å¼€å¯çµé­‚å¥‘åˆ</button>
    </div>

    <div id="chat-ui">
        <div id="status">æ­£åœ¨åŒæ­¥æ˜Ÿè½¨...</div>
        <div id="msg-box"></div>
        <div class="input-bar">
            <button id="v-btn" ontouchstart="recOn(event)" ontouchend="recOff(event)" onmousedown="recOn(event)" onmouseup="recOff(event)">ğŸ¤</button>
            <input type="text" id="ipt" placeholder="æ­¤åˆ»æƒ³è¯´ä»€ä¹ˆ..." autocomplete="off">
            <button onclick="doSend()" style="background:transparent; border:none; color:var(--accent); font-weight:bold; padding:0 10px; font-size:16px;">å‘é€</button>
        </div>
        <button onclick="location.reload()" style="background:none; border:none; color:rgba(255,255,255,0.2); font-size:11px; margin-top:5px; cursor:pointer;">æ–­å¼€å½“å‰ä¿¡å·</button>
    </div>

    <script>
        let peer, conn, recorder, chunks = [];
        // A/B è§’è‰²äº’æ–¥é€»è¾‘ï¼Œç¡®ä¿ä¸¤ç«¯èƒ½å‡†ç¡®ç¢°æ’
        const ID_A = "SOUL_VOICE_A";
        const ID_B = "SOUL_VOICE_B";

        function start() {
            document.getElementById('home-ui').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('home-ui').style.display = 'none';
                document.getElementById('chat-ui').style.display = 'flex';
            }, 500);

            peer = new Peer(ID_A);
            peer.on('open', () => {
                updateStatus("æ­£åœ¨å¯»æ‰¾å…±é¸£...");
                tryLink(ID_B);
            });
            peer.on('connection', c => { if(!conn) bind(c); });
            peer.on('error', e => {
                if(e.type === 'unavailable-id') {
                    peer = new Peer(ID_B);
                    peer.on('open', () => { updateStatus("å‘ç°é¢‘ç‡ï¼Œæ­£åœ¨å¯¹å‡†..."); tryLink(ID_A); });
                }
            });
        }

        function tryLink(target) {
            const timer = setInterval(() => {
                if (conn && conn.open) return clearInterval(timer);
                let c = peer.connect(target, { reliable: true });
                c.on('open', () => { bind(c); clearInterval(timer); });
            }, 1500);
        }

        function bind(c) {
            conn = c;
            updateStatus("âœ¨ çµé­‚å¥‘åˆæˆåŠŸ");
            // æ ¸å¿ƒä¿®å¤ï¼šç›‘å¬æ•°æ®æ¥æ”¶
            conn.on('data', data => {
                if(data.type === 'audio') {
                    const blob = new Blob([data.data], { type: 'audio/webm' });
                    render(blob, false, true);
                } else {
                    render(data, false, false);
                }
            });
            conn.on('close', () => location.reload());
        }

        function doSend() {
            const el = document.getElementById('ipt');
            const val = el.value.trim();
            if(!val) return;
            
            // æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥ conn.open ç¡®ä¿æ•°æ®çœŸæ­£å‘ç»™å¯¹æ–¹
            if(conn && conn.open) {
                conn.send(val); 
                render(val, true, false);
                el.value = '';
            } else {
                updateStatus("ğŸ”´ è¿æ¥å·²ä¸­æ–­ï¼Œæ­£åœ¨å°è¯•é‡è¿...");
            }
        }

        async function recOn(e) {
            e.preventDefault();
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(s);
                chunks = [];
                recorder.ondataavailable = ev => chunks.push(ev.data);
                recorder.onstop = async () => {
                    const b = new Blob(chunks, { type: 'audio/webm' });
                    if(conn && conn.open) {
                        const buffer = await b.arrayBuffer(); // è½¬Bufferæé«˜æˆåŠŸç‡
                        conn.send({ type: 'audio', data: buffer });
                        render(b, true, true);
                    }
                    s.getTracks().forEach(t => t.stop());
                };
                recorder.start();
                document.getElementById('v-btn').classList.add('rec');
            } catch(err) { alert("éº¦å…‹é£æœªæˆæƒ"); }
        }

        function recOff(e) {
            e.preventDefault();
            if(recorder && recorder.state === 'recording') {
                recorder.stop();
                document.getElementById('v-btn').classList.remove('rec');
            }
        }

        function render(content, isMe, isVoice) {
            const box = document.getElementById('msg-box');
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'other'}`;
            
            if(isVoice) {
                const url = URL.createObjectURL(content instanceof Blob ? content : new Blob([content]));
                div.innerHTML = `ğŸ”Š è¯­éŸ³æ¶ˆæ¯ (ç‚¹å‡»æ’­æ”¾)`;
                div.style.cursor = "pointer";
                div.onclick = () => { 
                    const audio = new Audio(url);
                    audio.play().catch(() => alert("è¯·ç¡®è®¤å…³é—­æ‰‹æœºé™éŸ³å¼€å…³"));
                };
            } else {
                div.innerText = content;
            }
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function updateStatus(s) { document.getElementById('status').innerText = s; }
        document.getElementById('ipt').onkeydown = e => { if(e.key === 'Enter') doSend(); };
    </script>
</body>
</html>
